<!DOCTYPE html>
<html>
	<head>
		<title><%= moduleName %></title>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">

		<% if (fgta5jsDebugMode) { %>
			<!-- DEBUG MODE -->
			<%- include(libDebug) %>
		<% } else { %>
			<!-- PRODUCTION -->
			<%- include(libProduction) %>
		<% } %>	


		<!-- WebModule library-->
		<script  src="public/libs/webmodule/module.js"></script>	
		<link rel="stylesheet" href="public/libs/webmodule/module.css" />		
		
		<% if (iconFileExists) { %>
		<link rel="icon" type="image/svg+xml" href="public/modules/<%= `${moduleName}/${iconFileName}` %>" />	
		<% } %>	

		<% if (cssExists) { %>
		<link rel="stylesheet" href="public/modules/<%= `${moduleName}/${moduleName}.css` %>" />
		<% } %>

		<% if (cssLayoutExists) { %>
		<link rel="stylesheet" href="public/modules/<%= `${moduleName}/${moduleName}.layout.css` %>" />
		<% } %>

		

		<style>
			#loadingindicator {
				position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; background-color: #fff;
				transition: opacity 0.5s ease, visibility 0.5s ease;
			}
		</style>

		<style>
			@import url("public/libs/fgta5js/fonts/karla.css");
			* { font-family: "Karla"; }
			input { user-select: text; }
			dialog { outline: none; }
			body {
				background-color: white;
				overscroll-behavior-y: contain;
				user-select: none;
				padding: 0px;
				margin: 0px;
				overscroll-behavior: contain;
				font-size: 14px;
			}

			/* khusus mobile */
			@media screen and (max-width: 500px) { 
				html, body, input, button { font-size: 20px; }
			}
		</style>


		<!-- additional header -->
		<% if (additionalHeaderExists) { %>
			<%- include(additionalHeaderPath) %>
		<% } %>


	</head>
	<body>
		<div id="loadingindicator">
			<div style="font-family: system-ui, sans-serif">
				loading module...
			</div>
		</div>		

		<!-- <%= moduleName %> -->
		<main id="mainapp"> 
		<%- include(ejsPath) %>
		</main>
		<div id="extender-templates" style="display: none;">
			<% if (htmlExtenderExists) { %>
			<%- include(htmlExtenderPath) %>
			<% } %>
		</div>
	</body>

	<script>
		// // prevent back button
		history.pushState(null, null, window.location.pathname);
		window.addEventListener('popstate', function(ev) {
			history.pushState(null, null, window.location.pathname);
		}, false);	
	</script>

	<script type="module">

		function removeLoadingIndicator() {
			const mainapp = document.getElementById('mainapp')
			const pagemask = document.getElementById('loadingindicator')
			mainapp.classList.remove('hidden')
			setTimeout(()=>{
				pagemask.style.opacity = 0
				pagemask.style.visibility = 'hidden'
				setTimeout(()=>{
					pagemask.parentNode.removeChild(pagemask)
				}, 500)
			}, 50)
		}

		async function preRender() {
			// loading  prerender mjs...  <% if (mjsPrerenderExists) { %> 
			const Prerenderer = await import('./public/modules/<%= `${moduleName}/${moduleName}-prerender.mjs` %>')
			await Prerenderer.prerender()
			// <% } else { %>
			// prerender does not exist
			// if you need to prerender page before processing,
			// you can create file <%= `${moduleName}-prerender.mjs` %>
			// and export function prerender()
			// <% } %>
		}

		async function Start() {
			// loading mjs...  <% if (!mjsExists) { %> 
			// Module belum didefinisikan
			console.warn("empty module: './public/modules/<%= `${moduleName}/${mjsFileName}` %>' not found!")
			removeLoadingIndicator()
			return
			// <% } %>

			window.addEventListener("load", async (event) => {
				try {
					await preRender()

					const Application = await import('./public/modules/<%= `${moduleName}/${mjsFileName}` %>'	)
					const $app = new Application.default();
					await $app.main();

					// window.onbeforeunload = function() { return "Your work will be lost."; };
				} catch (err) {
					console.error(err)
					const mainapp = document.getElementById('mainapp')
					if (err.status==401) {
						mainapp.innerHTML = '<div><h1 style="color:red">Need Authentication Access</h1><div>' + err.message + '</div></div>'
					} else {
						mainapp.innerHTML = '<div><h1 style="color:red">Module Error</h1><div>' + err.message + '</div></div>'
					}
				} finally {
					removeLoadingIndicator()
				}
			});
		}

		Start()

	</script>		
</html>